name: éƒ¨ç½²åˆ°GitHub Pageså’ŒGitee

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®PHPç¯å¢ƒ
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.4'
        extensions: mbstring, mysqli, pdo_mysql, gd, curl, json
    
    - name: éªŒè¯PHPè¯­æ³•
      run: |
        find . -name "*.php" -exec php -l {} \; > php_errors.log
        if [ -s php_errors.log ]; then
          echo "å‘ç°PHPè¯­æ³•é”™è¯¯ï¼š"
          cat php_errors.log
          exit 1
        fi
        echo "PHPè¯­æ³•æ£€æŸ¥é€šè¿‡"
    
    - name: å‹ç¼©èµ„æºæ–‡ä»¶
      run: |
        # å‹ç¼©CSSæ–‡ä»¶
        find assets/css -name "*.css" -exec gzip -k {} \;
        
        # å‹ç¼©JSæ–‡ä»¶
        find assets/js -name "*.js" -exec gzip -k {} \;
        
        # ä¼˜åŒ–å›¾ç‰‡
        sudo apt-get update && sudo apt-get install -y optipng jpegoptim
        find assets/images -name "*.png" -exec optipng {} \;
        find assets/images -name "*.jpg" -exec jpegoptim --strip-all {} \;
    
    - name: ç”Ÿæˆé™æ€æ–‡ä»¶
      run: |
        # åˆ›å»ºé™æ€ç‰ˆæœ¬ï¼ˆç§»é™¤PHPä¾èµ–ï¼‰
        mkdir -p static
        cp -r assets static/
        cp -r images static/
        cp manifest.json static/
        cp service-worker.js static/
        
        # åˆ›å»ºé™æ€HTMLç‰ˆæœ¬
        php -S localhost:8000 &
        sleep 2
        wget -r -np -k -p -E -e robots=off -P static http://localhost:8000/
        pkill -f "php -S localhost:8000"
    
    - name: éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./static
        publish_branch: gh-pages
        cname: phone-review-center.com  # å¯é€‰ï¼šè‡ªå®šä¹‰åŸŸå
    
    - name: åŒæ­¥åˆ°Gitee
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # è®¾ç½®Gité…ç½®
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
        git remote add gitee https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_PASSWORD }}@gitee.com/${{ secrets.GITEE_USERNAME }}/phone-review-center.git
        
        # æ¨é€åˆ°Gitee
        git push gitee main --force || true
    
    - name: æ„å»ºAndroid APK
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # å®‰è£…Android SDK
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jdk wget unzip
        
        # ä¸‹è½½Android SDK
        wget https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip
        unzip commandlinetools-linux-8512546_latest.zip
        mkdir -p android-sdk/cmdline-tools
        mv cmdline-tools android-sdk/cmdline-tools/latest
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export ANDROID_HOME=$PWD/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        
        # å®‰è£…å¿…è¦çš„SDKç»„ä»¶
        yes | sdkmanager --licenses
        sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        
        # æ„å»ºAPK
        cd android-app
        chmod +x gradlew
        ./gradlew assembleRelease || ./gradlew assembleDebug
        
        # ä¸Šä¼ APKåˆ°å‘å¸ƒåŒº
        cd ..
        mkdir -p release
        cp android-app/app/build/outputs/apk/*/*.apk release/ || true
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        zip -r phone-review-center.zip . -x "*.git*" "node_modules/*" "*.log"
        
        # ç§»åŠ¨æ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
        mkdir -p release
        mv phone-review-center.zip release/
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: phone-review-build
        path: release/
    
    - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
      if: success()
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸ“± GitHub Pages: https://${{ github.repository_owner }}.github.io/phone-review-center"
        echo "ğŸ”§ æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ°Artifacts"
        
        # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ°é’‰é’‰/ä¼ä¸šå¾®ä¿¡/Slack
        # curl -X POST "ä½ çš„Webhookåœ°å€" -H "Content-Type: application/json" -d '{"msg":"éƒ¨ç½²æˆåŠŸ"}'

  deploy-mysql:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®MySQL
      run: |
        # å®‰è£…MySQL
        sudo apt-get update
        sudo apt-get install -y mysql-server mysql-client
        
        # å¯åŠ¨MySQLæœåŠ¡
        sudo systemctl start mysql
        sudo systemctl enable mysql
        
        # åˆ›å»ºæ•°æ®åº“
        mysql -u root -e "CREATE DATABASE IF NOT EXISTS phone_review_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
        
        # å¯¼å…¥æ•°æ®åº“ç»“æ„
        if [ -f "database/phone_review_db.sql" ]; then
          mysql -u root phone_review_db < database/phone_review_db.sql
        fi
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®
        mysql -u root phone_review_db -e "
        INSERT INTO brands (name, slug, description, logo_url, phone_count, status) VALUES
        ('è‹¹æœ', 'apple', 'Apple iPhoneç³»åˆ—æ‰‹æœº', '/assets/images/brands/apple.png', 15, 1),
        ('ä¸‰æ˜Ÿ', 'samsung', 'Samsung Galaxyç³»åˆ—', '/assets/images/brands/samsung.png', 25, 1),
        ('å°ç±³', 'xiaomi', 'Xiaomi/Redmiç³»åˆ—', '/assets/images/brands/xiaomi.png', 30, 1),
        ('åä¸º', 'huawei', 'Huawei Mate/Pç³»åˆ—', '/assets/images/brands/huawei.png', 20, 1),
        ('OPPO', 'oppo', 'OPPO Find/Renoç³»åˆ—', '/assets/images/brands/oppo.png', 18, 1);
        
        INSERT INTO phones (name, brand_id, slug, price, processor_name, rear_camera_main, battery_capacity, status) VALUES
        ('iPhone 15 Pro Max', 1, 'iphone-15-pro-max', 9999, 'A17 Pro', '48MPä¸»æ‘„+12MPè¶…å¹¿è§’+12MPé•¿ç„¦', 4422, 1),
        ('Galaxy S24 Ultra', 2, 'galaxy-s24-ultra', 8999, 'Snapdragon 8 Gen 3', '200MPä¸»æ‘„+12MPè¶…å¹¿è§’+50MPé•¿ç„¦+10MPé•¿ç„¦', 5000, 1),
        ('Xiaomi 14 Ultra', 3, 'xiaomi-14-ultra', 6499, 'Snapdragon 8 Gen 3', '50MPä¸»æ‘„+50MPè¶…å¹¿è§’+50MPé•¿ç„¦+50MPé•¿ç„¦', 5300, 1),
        ('Mate 60 Pro+', 4, 'mate-60-pro-plus', 6999, 'Kirin 9000S', '48MPä¸»æ‘„+40MPè¶…å¹¿è§’+48MPé•¿ç„¦', 5000, 1),
        ('Find X7 Ultra', 5, 'find-x7-ultra', 5999, 'Snapdragon 8 Gen 3', '50MPä¸»æ‘„+50MPè¶…å¹¿è§’+50MPé•¿ç„¦+50MPé•¿ç„¦', 5000, 1);
        "
        
        echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
    
    - name: æµ‹è¯•æ•°æ®åº“è¿æ¥
      run: |
        # åˆ›å»ºæµ‹è¯•PHPæ–‡ä»¶
        cat > test_db.php << 'EOF'
        <?php
        require_once 'config/database.php';
        
        try {
            $pdo = new PDO("mysql:host=" . DB_HOST . ";dbname=" . DB_NAME, DB_USER, DB_PASS);
            $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            
            $stmt = $pdo->query("SELECT COUNT(*) as count FROM brands");
            $result = $stmt->fetch(PDO::FETCH_ASSOC);
            
            echo "æ•°æ®åº“è¿æ¥æˆåŠŸï¼å“ç‰Œæ•°é‡: " . $result['count'] . "\n";
        } catch (PDOException $e) {
            echo "æ•°æ®åº“è¿æ¥å¤±è´¥: " . $e->getMessage() . "\n";
            exit(1);
        }
        ?>
        EOF
        
        # è¿è¡Œæµ‹è¯•
        php test_db.php
    
    - name: æ¸…ç†æµ‹è¯•æ–‡ä»¶
      run: rm -f test_db.php

  notify:
    runs-on: ubuntu-latest
    needs: [deploy, deploy-mysql]
    if: always()
    
    steps:
    - name: å‘é€é€šçŸ¥
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ] && [ "${{ needs.deploy-mysql.result }}" == "success" ]; then
          echo "ğŸ‰ æ‰€æœ‰éƒ¨ç½²ä»»åŠ¡æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“± ç½‘ç«™åœ°å€: https://${{ github.repository_owner }}.github.io/phone-review-center"
          echo "ğŸ”§ ç®¡ç†åå°: https://${{ github.repository_owner }}.github.io/phone-review-center/admin"
          echo "ğŸ“Š æ•°æ®åº“: MySQLå·²åˆå§‹åŒ–å®Œæˆ"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
        fi